{% extends "main/base.html" %}
{% load url from future %}
{% load i18n %}
{% load notifications_tags %}
{% load bootstrap3 %}
{% block head_title %}Lugar{%endblock head_title%}
{% load static %}
{% block scripts %}

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCvfyKIBeaLLGXbF5HS73ZcfmDhPtM05rA&sensor=true"></script>
    <script src="{% static 'Gmaps/gmaps.js'%}"></script>

{% endblock %}
{% load static %}

{% block styles %}

         
        /*
A custom Bootstrap 3.1 theme from http://bootply.com\

This CSS code should follow the 'bootstrap.css'
in your HTML file.

license: MIT
author: bootply.com
*/


html,body{
    height:100%;
}

body{
    padding-top:50px; /*padding for navbar*/
}

.navbar-custom .icon-bar {
    background-color:#fff;
}

.navbar-custom {
    background-color: #168ccc;
    color:#fff;
}

.navbar-custom li>a:hover,.navbar-custom li>a:focus {
    background-color:#49bfff;
}

.navbar-custom a{
    color:#fefefe;
}

.navbar-custom .form-control:focus {
    border-color: #49bfff;
    outline: 0;
    -webkit-box-shadow: inset 0 0 0;
    box-shadow: inset 0 0 0;
}

#main, #main>.row {
    height:100%;
}

#main>.row {
    overflow-y:scroll;
}

#left {
    height:100%;
}

#map-canvas {
    width:40%;
    height:calc(100% - 0);
    position:absolute;
    right:16px;
    top:50px;
    bottom:0;
    overflow:hidden;
}

.media-body{
  height: 10em;
}

{% endblock styles %}





{% block content_free %}




<div id="map-canvas"></div>
<div class="container-fluid" id="main">
  <div class="row">
    <div class="col-xs-7 col-md-7 col-sm-7" id="left">
      <br><br>
    <div class="row">
      <div class="col-md-12">

      <div class="form-group"><label class="control-label" for="filtrado">Nombre</label>
    <input class="form-control" type="text" id="filtrado" placeholder="Nombre del lugar"/>
    </div>


      {% bootstrap_form form_categorias %}

      
   

<div class="form-group">
  <button type="button" class="btn btn-primary btn-sm " id="boton_aplicar_filtro">
  <span class="glyphicon glyphicon-filter"></span> Aplicar Filtro
  </button>

  <button type="button" class="btn btn-default  btn-sm  form-group" id="boton_limpiar">
  <span class=""></span> Limpiar
  </button>
</div>




      </div>
        
    </div>
    <div class="row" id="all_elements">
       <!-- Aca los items -->       
    </div>
    <div class="row">
    <div class="col-md-12 text-center">
      <ul class="pagination text-center">  
      </ul>
    </div>
    </div>
     
    </div>
    <div class="col-xs-5"><!--map-canvas will be postioned here-->
       
  </div>
    
  </div>
</div>

 <script src="{% static 'js/update_categoria.js'%}"></script>   



<script>

var x1,y1,x2,y2,pagina=1;
var pinColor = "47a3da";
var markers=[];
var actual_page=1;
var nombre_input,subcategoria_iput,categoria_input;
var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
        new google.maps.Size(21, 34),
        new google.maps.Point(0,0),
        new google.maps.Point(10, 34));



function add_marker(lng,lat,id,nombre){
  console.log("Esto llega: "+lng+" , "+lat);
  markers.push(map.addMarker({
    lat: lat,
    lng: lng,
    icon: pinImage,
    animation: google.maps.Animation.DROP,
    id:id,
    infoWindow: {
      content: '<h4><a href="/establecimientos/'+id+'">'+nombre+'</h4>'
    },
  }));  

  console.log("markers: ");
  console.log(markers);
}


function paginador(anterior,siguiente,current){
  $('.pagination').empty();
  if(anterior){
    $('<li class="link" data-page="'+anterior+'"><a  href="#">&laquo;</a></li>').appendTo(".pagination");  
  }

  if (anterior || siguiente){
    $('<li ><a href="#">'+current+'</a></li>').appendTo(".pagination");   
  }

  if(siguiente){
    $('<li class="link" data-page="'+siguiente+'"><a  href="#">&raquo;</a></li>').appendTo(".pagination");  
  }
  

}


function send_data(){
 $.ajax({
      url: '/establecimiento/boung/',
      type: 'GET',
      data: {"x1":x1,"x2":x2,"y1":y1,
      "y2":y2,"pagina":pagina, "nombre":nombre_input,
      "categoria":categoria_input,"sub_categoria":subcategoria_iput},
      dataType: 'json',
      success: function(response) {
        console.log("succes");
        console.log(response)
        console.log(response.results)

        siguiente=response.next
        anterior=response.previous
        cantidad=response.count
        console.log("Anterio")        
        paginador(anterior,siguiente,actual_page)

        map.removeMarkers();
        $( "#all_elements" ).empty();
        markers=[];
        if (response.results.length > 0){
          $("<div class='col-md-12'><h3 class='text-center'>Encontramos "+cantidad+" lugares que te gustaran</h3><br></div>").appendTo('#all_elements');
          console.log("Resultao");
          console.log(response.results);
          for (var i = response.results.length - 1; i >= 0; i--) {
            str_position=(response.results[i].position);   
            console.log(str_position);
            if (str_position){
              str_position=str_position.replace("(","");
              str_position=str_position.replace(")","");
              str_position=str_position.split(" ");

              cantidad=response.results.length
              id=response.results[i].id
              nombre=response.results[i].nombre
              subcategoria=response.results[i].sub_categorias
              descripcion=response.results[i].description
              description=""
              add_elemento(id,nombre,descripcion,subcategoria,cantidad)
              add_marker(parseFloat(str_position[1]),parseFloat(str_position[2]),id,nombre);
        }        
          };
        }  else{
            $('<div class="col-md-12"><h4 class="text-center">Opps No se encontr√≥ nada</h4></div>').appendTo("#all_elements");
        }     
        
      },
      error:function(error){
          console.log("ERROR");
          console.log(error);
      }
  });
}


//$('.link').click(function(){console.log("hola");});

$('.pagination').on('click', '.link', function(e) {
        //alert('Parameter: ' + $(this).attr('data-page').split("=")[1]);
        pagina=$(this).attr('data-page').split("=")[1];
        actual_page=$(this).attr('data-page').split("=")[1];
        send_data()

  });

function sra(){
   polygon = map.drawPolygon({
      paths: path, // pre-defined polygon shape
      strokeColor: '#BBD8E9',
      strokeOpacity: 1,
      strokeWeight: 3,
      fillColor: '#BBD8E9',
      fillOpacity: 0.6
    });

}


map = new GMaps({
  div: '#map-canvas',
  zoom: 13,
  lat: 4.579503,
  lng: -74.157113,
  scrollwheel: true,
  idle:function(e) {
    console.log(this.getBounds());

    var bounds = map.getBounds();

    var ne = bounds.getNorthEast();
    var sw = bounds.getSouthWest();


    // x1= this.getBounds().pa.j;
    // y1= this.getBounds().Ca.k;

    // x2= this.getBounds().pa.k;
    // y2= this.getBounds().Ca.j;

    x1=ne.lat()
    y1=sw.lng()

    x2=sw.lat()
    y2=ne.lng()

    // x2=ne.lat()
    // y2=sw.lng()

    // x1=sw.lat()
    // y1=ne.lng()


    path = [[x1,y1], [x1,y2], [x2,y2], [x2,y1],[x1,y1]];
    //path = [[-74.1,5.10], [x1,y2], [x2,y2],[-74.1,5.10]];    
    //path = [[-12.040397656836609,-77.03373871559225], [-12.040248585302038,-77.03993927003302], [-12.050047116528843,-77.02448169303511], [-12.044804866577001,-77.02154422636042]];
//    sra(path);

   
    
    send_data();
  },
  mousemove: function(e){
   // console.log("Latitude: "+e.latLng.lat());
    //console.log("Longitude: "+e.latLng.lng());
  }
});


// $('#all_elements').hover(function () {
//   //this.find( ".col-md-6" ).css( "background-color", "red" );
//   function() {
//     $( this ).append( $( "<span> ***</span>" ) );
//   }, function() {
//     $( this ).find( "span:last" ).remove();
//   }
//   });


// $( ".mierda").hover(  
//   function() {
//     //alert("ENTRO MIEDA");
//       //id=$(this).prop('id')
//       console.log("id");
//       //marker_only=$.grep(markers, function(e){ return e.id == id; })
//       //marker_only[0].setIcon();

//   }, function() {
//       //id=$(this).prop('id')
//       console.log("id");
//       //marker_only=$.grep(markers, function(e){ return e.id == id; })
//       //marker_only[0].setIcon("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|47a3da");      
//   }
// );



$(document).on({
    mouseenter: function () {
      id=$(this).prop('id')
      //console.log("id");
      marker_only=$.grep(markers, function(e){ return e.id == id; })
      marker_only[0].setIcon();
    },
    mouseleave: function () {
      id=$(this).prop('id')
      //console.log("id");
      marker_only=$.grep(markers, function(e){ return e.id == id; })
      marker_only[0].setIcon("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|47a3da");      
    }
}, ".mierda"); //pass the element as an argument to .on

function add_elemento(id,nombre,descripcion,subcategoria,cantidad){
    var item= "\
    <div class='col-md-6 mierda' id='"+id+"'> \
              <a href='/establecimientos/"+id+"' >\
              <div class='media' id=''>    \
                         <div class='media-body'  style='border-style: dotted;border-color: #47a3da; border-width: 2px;'>\
                          <br>\
                            <h4 class='media-heading text-center ' > "+nombre+" </h4>\
                            <div class='col-md-offset-1 col-md-10 col-md-offset-1'>\
                            <p class='text-justify'>"+descripcion+"</p>\
                            <h4><small>  </small> </h4>\
                            </div> \
                        </div>     \
                </div>  \
                </a>\
                <br><br>\
            </div>  \
    "
    $(item).appendTo("#all_elements");


}
//cargando datos
// $(document).on({
//     ajaxStart: function() { $("#myModal").modal('show'); },
//     ajaxStop: function() { $("#myModal").modal('hide'); }    
// });

// }


  $('#boton_aplicar_filtro').click(function(){
      nombre_input=$('#filtrado').val();
      categoria_input=$('#categoria').val();
      subcategoria_iput=$('#id_sub_categorias').val();
      send_data();
  })

  $('#boton_limpiar').click(function(){
    console.log("limpiando");
      $('#filtrado').val(null);
      $('#categoria option[value=""]').attr("selected",true);
      $( "#categoria" ).trigger( "click" );
      nombre_input=null;
      categoria_input=null;
      subcategoria_iput=null;
      send_data();
  })

</script>

{% endblock content_free %}
